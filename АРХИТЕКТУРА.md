# Архитектура — Pre-flight валидатор тендерной заявки

**Проект:** Pre-flight валидатор тендерной заявки
**Версия:** v1.0 MVP
**Дата:** 2026-02-06
**Фокус:** 44-ФЗ + услуги

---

## Общая архитектура

### Стек технологий

| Компонент | Технология | Версия | Зачем |
|---|---|---|---|
| **Frontend** | Next.js | 15+ | App Router, SSR, API routes |
| **UI Library** | shadcn/ui | latest | Компоненты на Radix UI |
| **Styling** | Tailwind CSS | 3+ | Utility-first CSS |
| **Backend** | Node.js | 20+ | Runtime |
| **Framework** | Express.js | 4+ | API сервер |
| **Database** | PostgreSQL | 15+ | Данные пользователей, проверки |
| **ORM** | Prisma | 5+ | Работа с базой данных |
| **File Storage** | S3 / Cloudflare R2 | — | Хранение файлов |
| **Deployment** | Vercel | — | Frontend + API routes |
| **Auth** | NextAuth.js | 5+ | Аутентификация |

---

## Frontend архитектура

### Структура приложения

```
src/
├── app/                          # Next.js App Router
│   ├── (auth)/                   # Auth layout
│   │   ├── login/
│   │   └── register/
│   ├── (dashboard)/              # Dashboard layout
│   │   ├── dashboard/            # Главная страница
│   │   ├── checks/               # Список проверок
│   │   ├── checks/[id]/          # Детали проверки
│   │   └── settings/             # Настройки
│   ├── api/                      # API routes
│   │   ├── upload/
│   │   ├── validate/
│   │   └── report/
│   └── layout.tsx
├── components/                   # React компоненты
│   ├── ui/                       # shadcn/ui компоненты
│   ├── auth/                     # Auth компоненты
│   ├── dashboard/                # Dashboard компоненты
│   ├── upload/                   # Загрузка файлов
│   ├── validation/               # Валидация
│   └── report/                   # Отчеты
├── lib/                          # Утилиты
│   ├── api.ts                    # API клиент
│   ├── crypto.ts                 # Работа с КЭП
│   ├── rules.ts                  # Rule-engine
│   └── utils.ts                  # Общие утилиты
├── hooks/                        # React hooks
│   useUpload.ts                  # Загрузка файлов
│   useValidation.ts              # Валидация
│   └── useReport.ts              # Отчеты
└── types/                        # TypeScript типы
    ├── index.ts                  # Главные типы
    ├── validation.ts             # Типы валидации
    └── report.ts                 # Типы отчетов
```

### Ключевые компоненты

#### 1. UploadZone (компонент загрузки)

```typescript
// components/upload/UploadZone.tsx
interface UploadZoneProps {
  onUpload: (files: File[]) => void;
  maxSize?: number; // в MB
  allowedFormats?: string[];
  disabled?: boolean;
}

// Функционал:
// - Drag & drop
// - Проверка форматов (PDF, DOCX, ZIP, SIG)
// - Проверка размера (≤100 MB)
// - Прогресс загрузки
// - Предпросмотр файлов
```

#### 2. ValidationReport (компонент отчета)

```typescript
// components/validation/ValidationReport.tsx
interface ValidationReportProps {
  errors: ValidationError[];
  warnings: ValidationWarning[];
  summary: ValidationSummary;
}

// Функционал:
// - Итоговая сводка (X критичных, Y предупреждений)
// - Детальный отчет по ошибкам
// - Критичность (BLOCK / WARN)
// - Рекомендации по исправлению
// - Экспорт в PDF
```

#### 3. Checklist (компонент чек-листа)

```typescript
// components/validation/Checklist.tsx
interface ChecklistProps {
  type: 'before-upload' | 'after-form2' | 'before-submit';
  items: ChecklistItem[];
}

// Функционал:
// - Чек-лист "Перед загрузкой"
// - Чек-лист "После Формы 2"
// - Чек-лист "Перед подачей"
// - Отмеченные галочки
```

---

## Backend архитектура

### Структура API

```
src/
├── api/                          # API сервер
│   ├── routes/                   # Express routes
│   │   ├── upload.ts             # POST /api/upload
│   │   ├── validate.ts           # POST /api/validate
│   │   ├── report.ts             # GET /api/report/:id
│   │   └── checks.ts             # GET /api/checks
│   ├── services/                 # Business logic
│   │   ├── UploadService.ts      # Загрузка файлов
│   │   ├── AnonymityCheckService.ts
│   │   ├── SignatureCheckService.ts
│   │   ├── RequiredDocsService.ts
│   │   ├── Form2ValidationService.ts
│   │   └── ReportService.ts
│   ├── integrations/             # Внешние интеграции
│   │   ├── CryptoProAPI.ts       # КриптоПро
│   │   ├── EGRULAPI.ts           # ЕГРЮЛ
│   │   └── ETPIAPI.ts            # ЭТП
│   ├── rules/                    # Rule-engine
│   │   ├── rules.json            # Правила валидации
│   │   ├── Validator.ts          # Валидатор
│   │   └── Engine.ts             # Rule-engine
│   └── middleware/               # Express middleware
│       ├── auth.ts               # Auth middleware
│       ├── rateLimit.ts          # Rate limiting
│       └── errorHandler.ts       # Error handling
```

### API endpoints

#### POST /api/upload
**Описание:** Загрузка пакета документов

**Request:**
```json
{
  "files": [
    {
      "name": "document1.pdf",
      "size": 1024000,
      "type": "application/pdf"
    }
  ],
  "procurementId": "string"
}
```

**Response:**
```json
{
  "uploadId": "uuid",
  "files": [
    {
      "id": "uuid",
      "name": "document1.pdf",
      "size": 1024000,
      "url": "https://storage..."
    }
  ]
}
```

#### POST /api/validate
**Описание:** Запуск проверки загруженных документов

**Request:**
```json
{
  "uploadId": "uuid",
  "form2": {
    // Данные из Формы 2
  }
}
```

**Response:**
```json
{
  "checkId": "uuid",
  "summary": {
    "totalErrors": 5,
    "blockingErrors": 2,
    "warnings": 3
  },
  "errors": [
    {
      "id": "uuid",
      "type": "BLOCK",
      "category": "anonymity",
      "message": "Найден логотип компании в документе",
      "file": "document1.pdf",
      "location": "стр. 1",
      "recommendation": "Удалите логотип и загрузите файл заново"
    }
  ]
}
```

#### GET /api/report/:checkId
**Описание:** Получение детального отчета

**Response:**
```json
{
  "checkId": "uuid",
  "summary": { ... },
  "errors": [ ... ],
  "warnings": [ ... ],
  "checklist": {
    "beforeUpload": [ ... ],
    "afterForm2": [ ... ],
    "beforeSubmit": [ ... ]
  }
}
```

---

## Rule-engine

### Структура правила

```typescript
// types/validation.ts
interface Rule {
  id: string;
  category: 'anonymity' | 'signature' | 'required-docs' | 'form2' | 'infrastructure';
  severity: 'BLOCK' | 'WARN';
  condition: (context: ValidationContext) => boolean;
  message: string;
  recommendation: string;
}
```

### Примеры правил

```json
// rules/rules.json
{
  "rules": [
    {
      "id": "anonymity-001",
      "category": "anonymity",
      "severity": "BLOCK",
      "name": "Проверка логотипа",
      "condition": "file.content.includes('компания') || file.content.includes('ООО')",
      "message": "Найдена информация о компании в документе",
      "recommendation": "Удалите логотип, название компании, ИНН и другие идентификаторы"
    },
    {
      "id": "signature-001",
      "category": "signature",
      "severity": "BLOCK",
      "name": "Проверка наличия КЭП",
      "condition": "!file.hasSignature",
      "message": "Документ не подписан",
      "recommendation": "Подпишите документ квалифицированной электронной подписью"
    },
    {
      "id": "signature-002",
      "category": "signature",
      "severity": "BLOCK",
      "name": "Проверка срока действия сертификата",
      "condition": "signature.cert.expired",
      "message": "Сертификат просрочен",
      "recommendation": "Обновите сертификат или используйте действующий"
    },
    {
      "id": "required-docs-001",
      "category": "required-docs",
      "severity": "BLOCK",
      "name": "Выписка из ЕГРЮЛ",
      "condition": "!files.includes('egrul') || file.egrulAge > 6",
      "message": "Отсутствует свежая выписка из ЕГРЮЛ",
      "recommendation": "Загрузите выписку из ЕГРЮЛ не старше 6 месяцев"
    },
    {
      "id": "form2-001",
      "category": "form2",
      "severity": "BLOCK",
      "name": "Страна происхождения",
      "condition": "form2.countryOfOrigin === undefined || form2.countryOfOrigin === ''",
      "message": "Не указана страна происхождения товара",
      "recommendation": "Укажите страну происхождения товара"
    },
    {
      "id": "form2-002",
      "category": "form2",
      "severity": "WARN",
      "name": "Расплывчатые формулировки",
      "condition": "form2.value.match(/от.*до|более.*менее|допускается/)",
      "message": "Обнаружена расплывчатая формулировка",
      "recommendation": "Избегайте расплывчатых формулировок, укажите точное значение"
    }
  ]
}
```

### Валидатор

```typescript
// rules/Validator.ts
export class Validator {
  constructor(private rules: Rule[]) {}

  async validate(context: ValidationContext): Promise<ValidationResult> {
    const errors: ValidationError[] = [];
    const warnings: ValidationWarning[] = [];

    for (const rule of this.rules) {
      if (await rule.condition(context)) {
        const issue = {
          id: rule.id,
          category: rule.category,
          message: rule.message,
          recommendation: rule.recommendation,
          ...this.getIssueDetails(context)
        };

        if (rule.severity === 'BLOCK') {
          errors.push(issue);
        } else {
          warnings.push(issue);
        }
      }
    }

    return {
      summary: {
        totalErrors: errors.length + warnings.length,
        blockingErrors: errors.length,
        warnings: warnings.length
      },
      errors,
      warnings
    };
  }

  private getIssueDetails(context: ValidationContext): any {
    // Извлечение деталей (файл, строка, позиция и т.д.)
  }
}
```

---

## Интеграции

### КриптоПро API

```typescript
// integrations/CryptoProAPI.ts
export class CryptoProAPI {
  async checkSignature(file: File): Promise<SignatureInfo> {
    // Проверка наличия КЭП
    // Проверка валидности сертификата
    // Проверка полномочий подписанта
  }

  async checkCertificate(certId: string): Promise<CertificateInfo> {
    // Проверка срока действия
    // Проверка статуса (отозван/действует)
    // Проверка доверенности (если нужно)
  }
}
```

### ЕГРЮЛ API

```typescript
// integrations/EGRULAPI.ts
export class EGRULAPI {
  async checkCompany(ogrn: string): Promise<CompanyInfo> {
    // Проверка статуса компании
    // Проверка на банкротство
    // Проверка на недобросовестность
  }

  async checkEGRULAge(file: File): Promise<number> {
    // Проверка свежести выписки (в месяцах)
  }
}
```

### ЭТП API

```typescript
// integrations/ETPIAPI.ts
export class ETPIAPI {
  async getProcurement(procurementId: string): Promise<ProcurementInfo> {
    // Получение данных о закупке
    // ТЗ, дедлайн, требования
  }

  async checkAccountStatus(userId: string): Promise<AccountStatus> {
    // Проверка статуса аккаунта
    // Проверка баланса лицевого счета
  }

  async getDeadline(procurementId: string): Promise<Date> {
    // Получение дедлайна подачи
  }
}
```

---

## База данных

### Схема (Prisma)

```prisma
// prisma/schema.prisma

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  company   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  checks    Check[]
}

model Check {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  uploadId    String   @unique
  procurement String?

  summary     Json
  errors      Json
  warnings    Json
  checklist   Json

  createdAt   DateTime @default(now())

  @@index([userId])
}

model File {
  id       String  @id @default(uuid())
  checkId  String
  check    Check   @relation(fields: [checkId], references: [id])

  name     String
  size     Int
  type     String
  url      String

  metadata Json?

  @@index([checkId])
}
```

---

## Развертывание

### Vercel (Frontend + API routes)

```json
// vercel.json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["hnd1"],
  "env": {
    "DATABASE_URL": "@database_url",
    "S3_BUCKET": "@s3_bucket",
    "S3_ACCESS_KEY": "@s3_access_key",
    "S3_SECRET_KEY": "@s3_secret_key",
    "CRYPTO_PRO_API_KEY": "@crypto_pro_api_key"
  }
}
```

### Репозиторий

```
├── .gitignore
├── .env.example
├── package.json
├── tsconfig.json
├── next.config.js
├── tailwind.config.js
├── postcss.config.js
├── prisma/
│   └── schema.prisma
├── src/
│   ├── app/
│   ├── components/
│   ├── lib/
│   ├── hooks/
│   └── types/
├── public/
│   └── images/
└── README.md
```

### Ветки

```
main           — продакшн (релизы)
├── dev        — разработка (фичи)
├── staging    — тестирование (pre-prod)
└── feature/*  — отдельные фичи
```

---

## Безопасность

1. **Аутентификация:** NextAuth.js с OAuth (Google, Yandex)
2. **Авторизация:** Проверка прав доступа к проверкам
3. **Rate limiting:** Ограничение запросов (100/мин для anon, 1000/мин для auth)
4. **Валидация:** Zod для валидации данных
5. **Encryption:** TLS 1.3 для всех соединений
6. **File security:** Изолированное хранение, удаление через 24 часа

---

## Метрики (Observability)

1. **Application Metrics:** Prometheus + Grafana
2. **Logging:** Winston (structured logs)
3. **Error Tracking:** Sentry
4. **Performance:** Web Vitals (LCP, FID, CLS)

---

## Next steps

1. Создать GitHub репозиторий
2. Настроить CI/CD (Vercel)
3. Инициализировать Next.js проект
4. Настроить shadcn/ui
5. Настроить Prisma + PostgreSQL
6. Разработать первые P0 фичи
7. Настроить интеграцию с КриптоПро
